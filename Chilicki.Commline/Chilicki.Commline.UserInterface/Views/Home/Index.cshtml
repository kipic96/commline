<script src="http://maps.google.com/maps/api/js?key=AIzaSyBhyRqrkWFUbHNYBnkPse8YGhw7j8uQBzE&sensor=true" type="text/javascript"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    #map_canvas img {
        max-width: none;
    }
</style>

<style>
    .infoDiv {
        height: 200px;
        width: 300px;
        -webkit-user-select: none;
        background-color: white;
    }
</style>
<br />
<div id="map_canvas" style="height: 550px;"></div>

@section scripts {
    <section class="scripts">

        <script type="text/javascript">
            var stopIconSize = 18;
            var map;
            var stopList = [];
            var stopLocations = [];
            var stopMarkerList = [];            

            var busStopImage = new google.maps.MarkerImage(
                'https://maps.gstatic.com/mapfiles/transit/iw2/6/bus.png',
                new google.maps.Size(stopIconSize, stopIconSize), //size
                null, //origin
                null, //anchor
                new google.maps.Size(stopIconSize, stopIconSize) //scale
            );

            $(document).ready(function () {
                InitializeMap();
                LoadAllStops();                
            });

            function InitializeMap() {
                google.maps.visualRefresh = true;
                var Tychy = new google.maps.LatLng(50.120965, 19.015120);
                var styles =
                    [
                        {
                            "featureType": "administrative",
                            "elementType": "geometry",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "poi",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "road",
                            "elementType": "labels.icon",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "transit",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        }
                    ]
                var styledMap = new google.maps.StyledMapType(styles, { name: "Styled Map" });
                var mapOptions = {
                    zoom: 13,
                    center: Tychy,
                    mapTypeControlOptions:
                        {
                            mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
                        }
                };
                map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
                map.mapTypes.set('map_style', styledMap);
                map.setMapTypeId('map_style');                

                google.maps.event.addListener(map, 'zoom_changed', function () {
                    var pixelSizeAtZoom0 = 5; 
                    var maxPixelSize = stopIconSize; 
                    var relativePixelSize = Math.round(pixelSizeAtZoom0 * Math.pow(2, map.getZoom())); 
                    if (relativePixelSize > maxPixelSize)
                        relativePixelSize = maxPixelSize;
                    if (map.getZoom() <= 12)
                        relativePixelSize = 0;
                    $.each(stopMarkerList, function (i, stopMarker) {
                        stopMarker.setIcon(
                            new google.maps.MarkerImage(
                                busStopImage.url,
                                null,
                                null,
                                null,
                                new google.maps.Size(relativePixelSize, relativePixelSize)
                            )
                        );
                    })
                });
            }

            function InitializeMarkers() {
                $.each(stopList, function (i, stop) {

                    var stopMarker = new google.maps.Marker({
                        'position': stopLocations[i],
                        'map': map,
                        'title': stop.Name,
                        'icon': busStopImage,
                    });

                    var infowindow = new google.maps.InfoWindow({
                        content: "<div class='infoDiv'><h2>" + stop.Name + "</div></div>"
                    });

                    google.maps.event.addListener(stopMarker, 'click', function () {
                        infowindow.open(map, stopMarker);
                    });
                    stopMarkerList.push(stopMarker);
                })

                var busPath = new google.maps.Polyline({
                    path: stopLocations,
                    strokeColor: "#0000FF",
                    strokeOpacity: 0.8,
                    strokeWeight: 2
                });
                busPath.setMap(map);                             
            }

            function LoadAllStops() {
                $.ajax({
                    type: "GET",
                    url: 'Home/GetAllStops',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (result) {
                        stopList = result;
                        stopLocations = [];
                        $.each(stopList, function (i, stop) {                            
                            stopLocations.push(new google.maps.LatLng(stop.Latitude, stop.Longitude))
                        });
                        InitializeMarkers();
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert("Request: " + XMLHttpRequest.toString() + "\n\nStatus: " + textStatus + "\n\nError: " + errorThrown);
                    }                    
                });
            }
            
        </script>
    </section>
}
